stages:          # List of stages for jobs, and their order of execution
  - build
  - test
  - deploy

build-job:       # This job runs in the build stage, which runs first.
  stage: build
  script:
    - docker build --no-cache -t goaccess_server:latest .

config:
  script: echo "hostname: https://goaccess.kiwi.local
listen: 0.0.0.0
port: 3050
version: \"1.0\"
loglevel: info
debug: off
hunter: off
cache: off
cache_srv: redis-cache
cache_port: \"6379\"" | yq -y    > config.yaml
  artifacts:
    paths:
      - config.yaml


test-job:
  stage: test
  script:
    - 
    - python3 ./test.py -a
    - docker compose -f ./docker-compose.yaml up  
    - docker compose -f ./docker-compose.yaml down
    - docker system prune --force

deploy-job:
  stage: deploy
  script:
    - docker save goaccess_server:latest > ./goaccess_server.tar
    - rsync -azvhP  --info=progress2 ./goaccess_server.tar orange:/home/orange/
    - ssh orange -t docker image load -i goaccess_server.tar
    - ssh orange -t docker compose -f  /opt/goAccess_server/docker-compose.yaml  --profile prod up -d --no-deps
    - rm ./goaccess_server.tar
    - docker system prune --force
    - ssh orange -t rm /home/orange/goaccess_server.tar
