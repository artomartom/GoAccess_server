stages:          
  - build
  - test
  - deploy

build-job:        
  stage: build
  script:
    - docker build -t goaccess_server:latest .



test-job:
  stage: test
  script:
    #- python3 ./test.py -a
    - docker compose -f ./docker-compose.yaml up -d
    - docker compose -f ./docker-compose.yaml down
    - docker system prune --force

deploy-job:
  stage: deploy
  script:
    - docker save goaccess_server:latest > ./goaccess_server.tar
    - rsync -azvhP  --info=progress2 ./goaccess_server.tar  orange:/home/orange/
    - rsync -azvhP  --info=progress2 ./docker-compose.prod.yaml orange:/opt/goAccess_server
    - ssh orange -t docker image load -i goaccess_server.tar   
    - ssh orange -t docker compose -f  /opt/goAccess_server/docker-compose.prod.yaml  up -d --no-deps
    - ssh orange -t rm /home/orange/goaccess_server.tar
    - rm ./goaccess_server.tar
