stages:          # List of stages for jobs, and their order of execution
  - build
  - test
  - deploy

build-job:       # This job runs in the build stage, which runs first.
  stage: build
  script:
    - docker build --no-cache -t goaccess_server:latest .

test-job:
  stage: test
  script:
    - echo "HOSTNAME='https://goaccess.orange.local'" >> .env
    - echo "LISTEN='0.0.0.0'" >> .env
    - echo "PORT=3050" >> .env
    - echo "VERSION='1.0'" >> .env
    - echo "CACHE" >> .env
    - echo "CACHE_SRV='redis-cache'" >> .env
    - echo "CACHE_PORT=6379" >> .env
    - echo "LOGLEVEL=info" >> .env
    - python3 ./test.py -a
    - docker compose -f ./docker-compose.yaml up  
    - docker compose -f ./docker-compose.yaml down
    - docker system prune --force

deploy-job:
  stage: deploy
  script:
    - docker save goaccess_server:latest > ./goaccess_server.tar
    - rsync -azvhP  --info=progress2 ./goaccess_server.tar orange:/home/orange/
    - ssh orange -t docker image load -i goaccess_server.tar && \
      docker compose -f  /opt/goAccess_server/docker-compose.yaml  --profile prod up -d --no-deps
    - rm ./goaccess_server.tar
    - ssh orange -t rm /home/orange/goaccess_server.tar
